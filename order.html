<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>สั่งก๋วยเตี๋ยวเรือ ป.ประทีป</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>สั่งก๋วยเตี๋ยวเรือ ป.ประทีป</h1>
  <p>โต๊ะ: {{ table_number }}</p>

  <div id="menu">
    {% for item in menu_items %}
    <div class="menu-item">
      <div>
        <div class="menu-name">{{ item['name'] }}</div>
        <div class="menu-price">{{ item['price'] }} บาท</div>
      </div>
      <div class="menu-qty">
        <button type="button" onclick="changeQty({{ item['id'] }}, '{{ item['name'] }}', {{ item['price'] }}, -1)">-</button>
        <span id="qty-{{ item['id'] }}">0</span>
        <button type="button" onclick="changeQty({{ item['id'] }}, '{{ item['name'] }}', {{ item['price'] }}, 1)">+</button>
      </div>
    </div>
    {% endfor %}
  </div>

  <button id="submitBtn" onclick="submitOrder()">ยืนยันสั่งอาหาร</button>
  <p id="status"></p>

  <script>
    const tableNumber = "{{ table_number }}";
    const cart = {};  // key: id, value: {name, price, qty}

    function changeQty(id, name, price, diff) {
      if (!cart[id]) {
        cart[id] = { name: name, price: price, qty: 0 };
      }
      cart[id].qty += diff;
      if (cart[id].qty < 0) cart[id].qty = 0;
      document.getElementById("qty-" + id).textContent = cart[id].qty;
    }

    async function submitOrder() {
      const items = [];
      for (const id in cart) {
        if (cart[id].qty > 0) {
          items.push({
            name: cart[id].name,
            quantity: cart[id].qty,
            price: cart[id].price
          });
        }
      }
      if (items.length === 0) {
        alert("กรุณาเลือกเมนูก่อน");
        return;
      }

      const res = await fetch("/api/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          table_number: tableNumber,
          items: items
        })
      });

      const data = await res.json();
      if (res.ok) {
        const orderId = data.order_id;
        document.getElementById("status").textContent = "สั่งอาหารเรียบร้อยแล้ว กำลังพาไปหน้าชำระเงิน...";
        window.location.href = "/pay/" + orderId;
      } else {
        document.getElementById("status").textContent = data.error || "เกิดข้อผิดพลาด";
      }
    }
  </script>
</body>
</html>
